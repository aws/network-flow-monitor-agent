#!/bin/bash

set -o pipefail
set -o nounset
set -x

source bin/set-env-vars

help_msg=$(cat <<EOF
Compare performance results with baseline
Usage: $0 --current-dir <dir> --baseline-dir <dir>
Examples:
    $0 --current-dir results-pr-123 --baseline-dir baseline-reports
EOF
)

current_dir=""
baseline_dir=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --current-dir=*) current_dir="${1#*=}" ;;
        --current-dir) current_dir="$2"; shift ;;
        --baseline-dir=*) baseline_dir="${1#*=}" ;;
        --baseline-dir) baseline_dir="$2"; shift ;;
        --help|-h) echo "$help_msg"; exit 0 ;;
    esac
    shift
done

if [[ -z "$current_dir" || -z "$baseline_dir" ]]; then
    log "ERROR: Both --current-dir and --baseline-dir are required"
    exit 1
fi

if [[ "$current_dir" == "$baseline_dir" ]]; then
    log "ERROR: current-dir and baseline-dir cannot be the same directory"
    exit 1
fi

if [[ ! -d "$current_dir" ]]; then
    log "ERROR: Current directory '$current_dir' does not exist"
    exit 1
fi


# Function to extract metric value from JSON report
get_metric() {
    local file="$1"
    local path="$2"
    local value=$(jq -r "$path // 0" "$file" 2>/dev/null || echo "0")
    printf "%.3f" "$value" 2>/dev/null || echo "$value"
}

# Function to calculate percentage change (returns numeric value or N/A)
calc_change_percent() {
    local old="$1"
    local new="$2"
    if [[ "$old" == "0" || "$old" == "0.000" ]]; then
        echo "N/A"
    else
        python3 -c "print(f'{((float('$new') - float('$old')) / float('$old') * 100):+.1f}')"
    fi
}

# Function to get performance limit for instance type and metric
get_limit() {
    local inst_type="$1"
    local metric_name="$2"
    local limits_file="instance-config.json"

    if [[ -f "$limits_file" ]]; then
        jq -r ".[\"$inst_type\"].limits[\"$metric_name\"] // null" "$limits_file" 2>/dev/null || echo "null"
    else
        echo "null"
    fi
}

# Function to check if value exceeds limit
check_limit() {
    local value="$1"
    local limit="$2"
    local metric_name="$3"

    if [[ "$limit" == "null" || "$limit" == "0" ]]; then
        echo ""
        return
    fi

    if (( $(awk "BEGIN {print ($value > $limit)}" 2>/dev/null || echo 0) )); then
        echo "âš ï¸"
    else
        echo "âœ…"
    fi
}

# Function to format change with icon (input is numeric or N/A, output adds %)
format_change() {
    local change="$1"
    if [[ "$change" == "N/A" ]]; then
        echo "$change"
        return
    fi
    if (( $(awk "BEGIN {print ($change > 10)}" 2>/dev/null || echo 0) )); then
        echo "ğŸ”»${change}%"
    elif (( $(awk "BEGIN {print ($change < -10)}" 2>/dev/null || echo 0) )); then
        echo "â–²${change}%"
    else
        echo "${change}%"
    fi
}

# Collect all data first for sorting
detailed_metrics_file=$(mktemp)
limit_breaches=0

# Associative arrays for aggregated metrics
declare -A metric_changes
declare -A metric_counts

# Compare each report file
for current_report in "$current_dir"/*_tps-report.json; do
    if [[ ! -f "$current_report" ]]; then
        continue
    fi

    filename=$(basename "$current_report")

    # Extract instance type and TPS from filename
    # Format: results-pr-58_m6a.xlarge_10000_tps-report.json or results-main-58_m6a.xlarge_10000_tps-report.json
    inst_type=$(echo "$filename" | sed 's/.*_\([^_]*\)_[0-9]*_tps-report.json/\1/')
    tps=$(echo "$filename" | sed 's/.*_\([0-9]*\)_tps-report.json/\1/')

    # Find matching baseline report by instance type and TPS (ignoring test-id prefix)
    baseline_report=$(find "$baseline_dir" -name "*_${inst_type}_${tps}_tps-report.json" -type f | head -n 1)

    # Check if baseline exists
    has_baseline=true
    if [[ -z "$baseline_report" || ! -f "$baseline_report" ]]; then
        has_baseline=false
    fi

    # Compare key metrics
    metrics=(
        "User CPU|.tps_report.sonar_agent_process.cpu_util_pct.avg"
        "User+BPF CPU 1-Core p90|(.tps_report.sonar_bpf_program.cpu_util_pct.p90 + .tps_report.sonar_agent_process.cpu_util_pct.p90) * .tps_report.cpu_cores"
        "Memory|.tps_report.sonar_agent_process.resident_mem_kb.avg"
        "BPF CPU|.tps_report.sonar_bpf_program.cpu_util_pct.avg"
    )

    for metric_def in "${metrics[@]}"; do
        metric_name=$(echo "$metric_def" | cut -d'|' -f1)
        metric_path=$(echo "$metric_def" | cut -d'|' -f2)

        current_val=$(get_metric "$current_report" "$metric_path")

        if [[ "$has_baseline" == "true" ]]; then
            baseline_val=$(get_metric "$baseline_report" "$metric_path")
            change_pct=$(calc_change_percent "$baseline_val" "$current_val")
        else
            baseline_val="N/A"
            change_pct="N/A"
        fi
        change_fmt=$(format_change "$change_pct")

        # Format values
        if [[ "$metric_name" == *"Memory"* ]]; then
            if [[ "$baseline_val" == "N/A" ]]; then
                baseline_fmt="N/A"
            else
                baseline_fmt="${baseline_val}KB"
            fi
            current_fmt="${current_val}KB"
        else
            baseline_fmt=$baseline_val
            current_fmt="$current_val"
        fi

        # Check against performance limits
        limit=$(get_limit "$inst_type" "$metric_name")
        limit_status=$(check_limit "$current_val" "$limit" "$metric_name")

        # Count limit breaches
        if [[ "$limit_status" == "âš ï¸" ]]; then
            ((limit_breaches++))
        fi

        # Format limit for display
        if [[ "$limit" != "null" ]]; then
            if [[ "$metric_name" == *"Memory"* ]]; then
                limit_fmt="${limit}KB"
            else
                limit_fmt=$limit
            fi
            limit_display="$limit_status $limit_fmt"
        else
            limit_display="$limit_status"
        fi

        # Store data for sorting: METRIC|TPS|INSTANCE
        printf "| %s | %d | %s | %s | %s | %s | %s |\n" "$metric_name" "$tps" "$inst_type" "$baseline_fmt" "$current_fmt" "$change_fmt" "$limit_display" >> "$detailed_metrics_file"

        # Accumulate individual changes for aggregated metrics
        if [[ "$change_pct" != "N/A" ]]; then
            metric_changes["$metric_name"]=$(awk "BEGIN {print ${metric_changes[$metric_name]:-0} + $change_pct}")
            metric_counts["$metric_name"]=$((${metric_counts[$metric_name]:-0} + 1))
        fi
    done
done

# Print Aggregated summary metrics first
echo ""
echo "## ğŸ“ˆ Aggregated Metrics Comparison"
echo "| Metric | Avg Change |"
echo "|--------|------------|"

for metric_name in "${!metric_changes[@]}"; do
    total_change_pct=${metric_changes[$metric_name]}
    count=${metric_counts[$metric_name]}

    avg_change_pct=$(awk "BEGIN {printf \"%+.1f\", $total_change_pct / $count}")
    change_fmt=$(format_change "$avg_change_pct")

    echo "| $metric_name | $change_fmt |"
done

## Print detailed metrics next
echo "## ğŸ“Š Detailed Metrics Comparison"
echo "| Metric | TPS | Instance Type | Baseline |  Current  |  Change  |       Limit      |"
echo "|--------|-----|---------------|----------|-----------|----------|------------------|"

# Sort by metric name, then TPS, then instance type
sort -t'|' -k2,2 -k3,3n -k4,4 "$detailed_metrics_file"
rm -f "$detailed_metrics_file"

echo ""
log "ğŸ”» = Significant increase (>10%)  â–² = Significant improvement (>10% decrease)  âš ï¸ = Exceeds performance limit"

# Exit with error if any limits were breached
if [[ $limit_breaches -gt 0 ]]; then
    log "ERROR: $limit_breaches performance limit(s) exceeded. Failing tests"
    exit 1
fi