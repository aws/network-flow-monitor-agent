#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

source bin/set-env-vars

help_msg=$(cat <<EOF
Compare performance results with baseline
Usage: $0 --current-dir <dir> --baseline-dir <dir>
Examples:
    $0 --current-dir results-pr-123 --baseline-dir baseline-reports
EOF
)

current_dir=""
baseline_dir=""

while [[ $# -gt 0 ]]; do
    case "$1" in
        --current-dir=*) current_dir="${1#*=}" ;;
        --current-dir) current_dir="$2"; shift ;;
        --baseline-dir=*) baseline_dir="${1#*=}" ;;
        --baseline-dir) baseline_dir="$2"; shift ;;
        --help|-h) echo "$help_msg"; exit 0 ;;
    esac
    shift
done

if [[ -z "$current_dir" || -z "$baseline_dir" ]]; then
    log "ERROR: Both --current-dir and --baseline-dir are required"
    exit 1
fi

if [[ "$current_dir" == "$baseline_dir" ]]; then
    log "ERROR: current-dir and baseline-dir cannot be the same directory"
    exit 1
fi

if [[ ! -d "$current_dir" ]]; then
    log "ERROR: Current directory '$current_dir' does not exist"
    exit 1
fi


# Function to extract metric value from JSON report
get_metric() {
    local file="$1"
    local path="$2"
    jq -r "$path // 0" "$file" 2>/dev/null || echo "0"
}

# Function to calculate percentage change
calc_change() {
    local old="$1"
    local new="$2"
    if [[ "$old" == "0" || "$old" == "0.000" ]]; then
        echo "N/A"
    else
        python3 -c "print(f'{((float('$new') - float('$old')) / float('$old') * 100):+.2f}%')"
    fi
}

# Function to get performance limit for instance type and metric
get_limit() {
    local inst_type="$1"
    local metric_name="$2"
    local limits_file="instance-config.json"

    if [[ -f "$limits_file" ]]; then
        jq -r ".[\"$inst_type\"].limits[\"$metric_name\"] // null" "$limits_file" 2>/dev/null || echo "null"
    else
        echo "null"
    fi
}

# Function to check if value exceeds limit
check_limit() {
    local value="$1"
    local limit="$2"
    local metric_name="$3"

    if [[ "$limit" == "null" || "$limit" == "0" ]]; then
        echo ""
        return
    fi

    if (( $(echo "$value > $limit" | bc -l 2>/dev/null || echo 0) )); then
        echo "âš ï¸"
    else
        echo "âœ…"
    fi
}

# Generate comparison report
echo "## ğŸ“Š Performance Comparison"
echo ""
echo "| Metric | Instance Type | TPS | Baseline | Current | Limit | Change |"
echo "|--------|---------------|-----|----------|---------|-------|--------|"

# Collect all data first for sorting
tmp_file=$(mktemp)
limit_breaches=0

# Compare each report file
for current_report in "$current_dir"/*_tps-report.json; do
    if [[ ! -f "$current_report" ]]; then
        continue
    fi

    filename=$(basename "$current_report")
    baseline_report="$baseline_dir/$filename"

    # Check if baseline exists, compare against that too if it exists
    has_baseline=true
    if [[ ! -f "$baseline_report" ]]; then
        has_baseline=false
    fi

    # Extract instance type and TPS from filename
    # Format: results-pr-58_m6a.xlarge_10000_tps-report.json
    inst_type=$(echo "$filename" | sed 's/.*_\([^_]*\)_[0-9]*_tps-report.json/\1/')
    tps=$(echo "$filename" | sed 's/.*_\([0-9]*\)_tps-report.json/\1/')

    # Compare key metrics
    metrics=(
        "User CPU|.tps_report.sonar_agent_process.cpu_util_pct.avg"
        "User CPU Single Core|(.tps_report.sonar_bpf_program.cpu_util_pct.max + .tps_report.sonar_agent_process.cpu_util_pct.max) * .tps_report.cpu_cores"
        "Memory|.tps_report.sonar_agent_process.resident_mem_kb.avg"
        "BPF CPU|.tps_report.sonar_bpf_program.cpu_util_pct.avg"
    )

    for metric_def in "${metrics[@]}"; do
        metric_name=$(echo "$metric_def" | cut -d'|' -f1)
        metric_path=$(echo "$metric_def" | cut -d'|' -f2)

        current=$(get_metric "$current_report" "$metric_path")

        if [[ "$has_baseline" == "true" ]]; then
            baseline_val=$(get_metric "$baseline_report" "$metric_path")
            change=$(calc_change "$baseline_val" "$current")
        else
            baseline_val="N/A"
            change="N/A"
        fi

        # Format values
        if [[ "$metric_name" == *"Memory"* ]]; then
            if [[ "$baseline_val" == "N/A" ]]; then
                baseline="N/A"
            else
                baseline="${baseline_val}KB"
            fi
            current="${current}KB"
        else
            baseline=$baseline_val
        fi

        # Add emoji for significant changes
        change_icon=""
        if [[ "$change" != "N/A" ]]; then
            change_num=$(echo "$change" | sed 's/[+%]//g')
            if (( $(echo "$change_num > 10" | bc -l 2>/dev/null || echo 0) )); then
                change_icon="ğŸ”´"
            elif (( $(echo "$change_num < -10" | bc -l 2>/dev/null || echo 0) )); then
                change_icon="ğŸŸ¢"
            fi
        fi

        if [[ -n "$change_icon" ]]; then
            change="$change_icon $change"
        fi

        # Check against performance limits
        limit=$(get_limit "$inst_type" "$metric_name")
        limit_status=$(check_limit "$current" "$limit" "$metric_name")

        if [[ -n "$limit_status" ]]; then
            current="$limit_status $current"
        fi

        # Count limit breaches
        if [[ "$limit_status" == "âš ï¸" ]]; then
            ((limit_breaches++))
        fi

        # Format limit for display
        if [[ "$limit" != "null" ]]; then
            if [[ "$metric_name" == *"Memory"* ]]; then
                limit="${limit}KB"
            fi
        fi

        # Store data for sorting: TPS|METRIC|INSTANCE|ROW
        printf "| %s | %s | %d | %s | %s | %s | %s |\n" "$metric_name" "$inst_type" "$tps" "$baseline" "$current" "$limit" "$change" >> "$tmp_file"
    done
done

# Sort by TPS, then metric, then instance type and output
if [[ -s "$tmp_file" ]]; then
    sort -t'|' -k1,1n -k2,2 -k3,3 "$tmp_file"
else
    log "No matching reports found for comparison."
fi
rm -f "$tmp_file"

echo "-----"

log "ğŸ”´ = Significant increase (>10%)  ğŸŸ¢ = Significant improvement (>10% decrease)  âš ï¸ = Exceeds performance limit"

# Exit with error if any limits were breached
if [[ $limit_breaches -gt 0 ]]; then
    log "ERROR: $limit_breaches performance limit(s) exceeded. Failing tests"
    exit 1
fi