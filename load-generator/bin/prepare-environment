#!/bin/bash

set -o errexit
set -o pipefail
set -o nounset

source bin/set-env-vars

handle_error() {
    msg=$1
    log "[ERROR] $msg"
    exit 1
}

# Confirm kernel 4.13 or later.
uname -r | cut -d. -f1,2 | tr '.' ' ' | awk '{
    if($1 > 4 || ($1 == 4 && $2 >= 13)) { \
        printf "[INFO] Kernel version is good\n" \
    } else { \
        printf "[ERROR] Kernel version must be above 4.13, found %d.%d\n", $1, $2; \
        exit 1;
    } \
}'

# Setup tc/qdisc for traffic manipulation
sudo yum install -y iproute-tc

# Validate the BPF setup.
yum install -y bpftool tree
yum install -y sysstat
# Explicitly set PATH to include common binary locations
export PATH=/usr/sbin:/sbin:/usr/local/sbin:$PATH
log "PATH is set to: $PATH"
which bpftool || handle_error "bpftool not found in PATH: $PATH"
which bpftop || handle_error "bpftop not found in PATH: $PATH"

grep CONFIG_BPF_SYSCALL=y /boot/config-$(uname -r) || handle_error 'BPF syscalls not enabled'
grep CONFIG_CGROUP_BPF=y /boot/config-$(uname -r) || handle_error 'BPF cgroups not enabled'
/usr/sbin/bpftool feature | grep 'sock_ops is available' || handle_error 'BPF sock_ops not enabled'
log "✅ BPF features are OK"
mount | grep cgroup2 | \
    awk '{if ($3 != "/sys/fs/cgroup") {printf "[WARN] Note the atypical cgroup mount point: "$3"\n"}}' \
    || handle_error 'Mounted cgroup2 not found'
log "✅ Cgroup v2 is OK"
# Install flamegraph dependencies.
yum install -y gcc make # Install GCC cause c compiler is required for flamegraph
log "✅ GCC is installed"
curl https://sh.rustup.rs -sSf | sh -s -- -y # Cargo
source $HOME/.cargo/env # Source the cargo environment
log "✅ Rust is installed. Installing Perf"
yum install -y perf
log "✅ Perf is installed. Installing Flamegraph"
cargo install flamegraph
log "✅ Flamegraph is installed"
sudo ln -sf $HOME/.cargo/bin/* /usr/local/bin/

# Set up network namespaces for the tcp-tester.
log "Setting up network config"
bin/network-setup.sh

if [ -n "${LOAD_TEST_ENABLE_NETWORK_LOSS}" ]; then
    bin/configure_loss --enable --loss_percent 10 --delay 50ms --jitter 500ms
else
    bin/configure_loss --disable
fi
log "✅ Network config is setup"

log "✅ [INFO] Success! ✅"
